#!/bin/sh
# mirage2iso
# (c) 2009 Michał Górny
# released under 3-clause BSD license

conf_check() {
	if [ -f "$1" ]; then
		echo "$3 found." >&2
	else
		echo "#define $2 1"
		echo "$3 unavailable." >&2
	fi
}

conf_results() {
	conf_check check-getopt.o NO_GETOPT_LONG 'getopt_long()'
	conf_check check-sysexits.o NO_SYSEXITS '<sysexits.h>'
	conf_check check-mmapio.o NO_MMAPIO 'mmap() & ftruncate()'
	conf_check check-assuan NO_ASSUAN 'assuan'
}

MAKEIN=Makefile.in

# Both can fail
ASSUAN_CPPFLAGS="$(libassuan-config --cflags 2>/dev/null)"
ASSUAN_LIBS="$(libassuan-config --libs 2>/dev/null)"
ASSUAN_LIBS="${ASSUAN_LIBS:--lassuan}" # fallback

make ${MAKEFLAGS:-${MAKEOPTS}} -f ${MAKEIN} -k \
	ASSUAN_CPPFLAGS="${ASSUAN_CPPFLAGS}" \
	ASSUAN_LIBS="${ASSUAN_LIBS}" \
	configure

if [ ! -f check-assuan ]; then
	ASSUAN_CPPFLAGS=
	ASSUAN_LIBS=
fi

conf_results > mirage-config.h
make -f ${MAKEIN} confclean

cat - ${MAKEIN} << _EOF_ > ${MAKEIN%.in}
# autogenerated by configure, please modify Makefile.in instead

CONF_CPPFLAGS = $(pkg-config --cflags libmirage) ${ASSUAN_CPPFLAGS}
CONF_LDFLAGS = $(pkg-config --libs-only-L --libs-only-other libmirage)
CONF_LIBS = $(pkg-config --libs-only-l libmirage) ${ASSUAN_LIBS}

_EOF_

echo Done.

exit 0
